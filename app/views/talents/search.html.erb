<div class="wrapper skill-icon-area-container">
    <div class="row">
        <div class="col-md-6">
            <h2 class="name">Welcome, <%= @user.name.capitalize %></h2>
            	<p>Find Altruists here</p>       
        </div>
        <div class="col-md-6">
            <div class="skills-logo-area">
                <img class="skills-icon" src="/assets/search-img-dog.png">
            		<h2><bold>Search in our API</bold></h2>  
            </div>
       </div>
    </div>
</div>






<br>
<div class="container">
	<div class="ui-widget">
	    <label for="tags">Search for a city:</label><img class="city-search-icon" src="/assets/city-bcn.png"><br> <input class="search-field" id=
	    "tags"> 
	</div>
</div>
<br>
<div class="container search-tabs">
    <ul class="nav nav-tabs" id="myTab">
        <li class="active">
            <a data-toggle="tab" href="#all-skills" id="skill-label">All
            Talents</a>
        </li>
        <li>
            <a data-toggle="tab" href="#top-rated-skills" id=
            "top-rated-skills-tab">Chosen Talent</a>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade in active" id="all-skills">
            <p>Search in a city to get a list of the talents there.</p>
        </div>
        <div class="tab-pane fade" id="top-rated-skills">
            <p id="talent-not-picked">Pick a city first</p><label for=
            "datas">Pick a talent:</label> <select class="search-field" id=
            "datas" name="datas">
                </select>
        </div>
    </div>
</div>

<script type="text/javascript">

var Search = function(city,talent){
	this.city = city;
	this.talent = talent;
}
var newSeach = new Search('','');

function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}


function createArrayWithTalentsInCity(response){
	$('#datas').empty();
	$('#all-skills').empty();
	var talentsFound = [];
	for(var i = 0; i < response.length; i++){
		if(talentsFound.indexOf(response[i].name) == -1){
			var obj = {};
			obj[i.toString()] = capitalizeFirstLetter(response[i].name);
			talentsFound.push(response[i].name);
		}
	}
	populateSelectOptionsAndTags(talentsFound.sort());
}
	
function processResponse(response,option){
	if(option == 1){
		createArrayWithTalentsInCity(response);
	}
	else {
		populateTopSkillForTag(response);
	}
}

function populateSelectOptionsAndTags(selected){
	$('#datas').append('<option disabled selected> -- select an option -- </option>');
	for (var i=0;i<selected.length;i++){
	   $('<option/>').val(selected[i]).html(selected[i]).appendTo('#datas');
	   $('<p/>').val(selected[i]).html(selected[i]).appendTo('#all-skills');
	}
}

function populateTopSkillForTag(response){
	$('.top-rated-p').remove();
	for (var i=0;i<response.length;i++){
			$("<p class='top-rated-p'>User: " +
			response[i][0]['user_name'] +
			" talent: " + 
			response[i][0].found['name']+
			" rating: " +
			response[i][0].found['rating'] +
			"</p>" + 
			"<a href='https://altruist.herokuapp.com/users/"+
			response[i][0]['user_id'] + 
			"/talents/" + 
			response[i][0].found['id'] + 
			"'>Contact</a>").appendTo('#top-rated-skills');
	}
}

function ajaxCall(url,option){
	$.ajax({url: url,
  	success: 
  	function (data) {
        processResponse(data, option)}
	});
}

$(document).ready(function(){
	var cities = <%= raw @cities %>;
	var talents = <%= raw @talents %>;
	$('#tags').autocomplete({
      source: cities,
	  select: function(event, ui) {
        	if (ui.item) {
        		$('.top-rated-p').remove();
        		newSeach.city = '';
        		newSeach.city = ui.item.value;
	        	$('#tags').val(newSeach.city);
	        	$('#skill-label').empty();
	        	$('#skill-label').append('All talents in '+ (newSeach.city));
	        	$('#talent-not-picked').empty();
	        	$('#talent-not-picked').append('Choose a talent to see how it does in '+ (newSeach.city))
	        	var url = "https://altruist.herokuapp.com/api/v1/"+newSeach.city+"/talents";
	        	ajaxCall(url,1);
    		}
   		}
    });
})

$(document).ready(function(){
	$('select').on('change', function () {
	   var talent = this.value;
	   var url = "https://altruist.herokuapp.com/api/v1/cities/"+newSeach.city+"/talents/"+talent;
	   console.log(url)
		ajaxCall(url,2);
	});
})

// $(document).ready(function(){
// 	$('#top-rated-skills-tab').click(function(){
// 	if ( $('#talent-not-picked').length  ){
// 		$('#talent-not-picked').remove();
// 		setTimeout(function(){
//     		$('.search-field').animate({backgroundColor: 'green'}).animate({backgroundColor: 'transparent'},'slow')
//     	},1000)
// 	}
// 	})
// })


</script>